<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Presentation</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
        body { margin:0; background:#222; display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:100vh; }
        
        #presentation-canvas { width:1280px; height:720px; max-width:100vw; max-height:90vh; display:block; }
        .back-btn { position:fixed; top:16px; left:16px; background:#fff; color:#232946; border:none; border-radius:6px; padding:8px 18px; font-weight:600; cursor:pointer; font-size:1rem; }
    </style>
</head>
<body>
  
    <div class="presentation-canvas-wrapper">
        <canvas id="presentation-canvas"></canvas>
    </div>
    <script>    
    // Firebase config
    const firebaseConfig = {
        apiKey: "AIzaSyB5BbeLLvPX8l1c4Lq0f-CmIUml4hQOQlE",
        authDomain: "edutaktika.firebaseapp.com",
        databaseURL: "https://edutaktika-default-rtdb.firebaseio.com",
        projectId: "edutaktika",
        storageBucket: "edutaktika.appspot.com",
        messagingSenderId: "676848575316",
        appId: "1:676848575316:web:f78f8c0f83bf3d9dfb5ec1",
        measurementId: "G-X3GT5TNN87"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Get URL params
    function getParam(name) {
        const url = new URL(window.location.href);
        return url.searchParams.get(name);
    }
    const subject = getParam('subject');
    const quarter = getParam('quarter');
    const name = getParam('name');

    // Setup Fabric canvas
    const canvas = new fabric.Canvas('presentation-canvas', {
        backgroundColor: '#fff',
        width: 1280,
        height: 720,
        selection: false
    });

    // Make all objects unselectable and not editable after loading
    function lockCanvasObjects() {
        canvas.getObjects().forEach(obj => {
            obj.selectable = false;
            obj.evented = false;
            obj.hasControls = false;
            obj.hasBorders = false;
            if (obj.type === 'group' && obj._objects) {
                obj._objects.forEach(child => {
                    child.selectable = false;
                    child.evented = false;
                    child.hasControls = false;
                    child.hasBorders = false;
                });
            }
        });
        canvas.selection = false;
        canvas.discardActiveObject();
        canvas.renderAll();
    }

    let slides = [];
    let currentSlide = 0;

    // Create navigation UI for presentation
    const navBar = document.createElement('div');
    navBar.style = 'position:fixed;bottom:24px;left:50%;transform:translateX(-50%);z-index:20;display:flex;gap:12px;';
    navBar.innerHTML = `
        <button id="prev-slide-btn" style="padding:8px 18px;border-radius:6px;border:none;background:#b39ddb;color:#232946;font-weight:600;cursor:pointer;">Prev Slide</button>
        <span id="slide-indicator" style="font-size:1.1em;font-weight:bold; color:white;">Slide 1/1</span>
        <button id="next-slide-btn" style="padding:8px 18px;border-radius:6px;border:none;background:#b39ddb;color:#232946;font-weight:600;cursor:pointer;">Next Slide</button>
    `;
    document.body.appendChild(navBar);

    function updateSlideIndicator() {
        document.getElementById('slide-indicator').textContent = `Slide ${currentSlide+1}/${slides.length}`;
    }
    function loadSlide(idx) {
        if (slides[idx]) {
            canvas.loadFromJSON(slides[idx], function() {
                canvas.renderAll();
                lockCanvasObjects(); // <-- Add this line
                updateSlideIndicator();
                showGameIframe(slides[currentSlide], document.getElementById('presentation-canvas'));
            });
        }
    }

    // Show game iframe if exists for the slide
    function showGameIframe(slide, canvasEl) {
        let existing = document.getElementById('game-iframe');
        // Remove if no game
        if (!slide.game || !slide.game.url) {
            if (existing) existing.remove();
            return;
        }
        // Show if game exists
        if (!existing) {
            const wrapper = document.querySelector('.presentation-canvas-wrapper');
            const rect = canvasEl.getBoundingClientRect();
            const iframe = document.createElement('iframe');
            iframe.id = 'game-iframe';
            iframe.src = slide.game.url;
            iframe.style.position = 'absolute';
            iframe.style.top = canvasEl.offsetTop + 'px';
            iframe.style.left = canvasEl.offsetLeft + 'px';
            iframe.style.width = rect.width + 'px';
            iframe.style.height = rect.height + 'px';
            iframe.style.border = 'none';
            iframe.style.zIndex = '10';
            iframe.allow = 'fullscreen';
            wrapper.style.position = 'relative';
            wrapper.appendChild(iframe);
        }
    }

    // Add this function to keep the iframe in sync with the canvas size
    function syncGameIframeSize() {
        const iframe = document.getElementById('game-iframe');
        const canvasEl = document.getElementById('presentation-canvas');
        if (iframe && canvasEl) {
            const rect = canvasEl.getBoundingClientRect();
            iframe.style.width = rect.width + 'px';
            iframe.style.height = rect.height + 'px';
            iframe.style.top = canvasEl.offsetTop + 'px';
            iframe.style.left = canvasEl.offsetLeft + 'px';
            iframe.style.transform = '';
        }
    }
    window.addEventListener('resize', syncGameIframeSize);

    // Function to list all presentations for the selected subject and quarter
    function listPresentations() {
        if (!subject || !quarter) {
            document.body.insertAdjacentHTML('beforeend', `<div style="color:white;text-align:center;margin-top:40px;">Please specify both subject and quarter in the URL.<br>Example: <code>?subject=subject_math&quarter=1</code></div>`);
            return;
        }
        db.ref('presentations/' + subject + '/quarter-' + quarter).once('value', function(snapshot) {
            if (!snapshot.exists()) {
                document.body.insertAdjacentHTML('beforeend', `<div style="color:white;text-align:center;margin-top:40px;">No presentations found for this subject and quarter.</div>`);
                return;
            }
            const listDiv = document.createElement('div');
            listDiv.style = 'margin:40px auto 0 auto;max-width:600px;background:#fff;border-radius:12px;padding:32px;box-shadow:0 4px 24px #0002;';
            listDiv.innerHTML = `<h2 style="margin-top:0;">Presentations for ${subject.replace('subject_','').toUpperCase()} - Quarter ${quarter}</h2><ul id="presentation-list" style="list-style:none;padding:0;"></ul>`;
            document.body.appendChild(listDiv);
            const ul = document.getElementById('presentation-list');
            snapshot.forEach(child => {
                const data = child.val();
                const li = document.createElement('li');
                li.style = 'margin-bottom:18px;padding:12px 0;border-bottom:1px solid #eee;';
                li.innerHTML = `
                    <strong>${data.title || child.key}</strong>
                    <div style="font-size:0.95em;color:#444;">${data.description || ''}</div>
                    <button style="margin-top:6px;padding:6px 18px;border-radius:6px;border:none;background:#b39ddb;color:#232946;font-weight:600;cursor:pointer;"
                        onclick="window.location.href='present.html?subject=${encodeURIComponent(subject)}&quarter=${encodeURIComponent(quarter)}&name=${encodeURIComponent(child.key)}'">
                        View Presentation
                    </button>
                `;
                ul.appendChild(li);
            });
        });
    }

    // If no name param, show all presentations for the subject and quarter
    if (!name) {
        listPresentations();
    } else {
        // ...existing code to load and show a single presentation...
        db.ref('presentations/' + subject + '/quarter-' + quarter + '/' + name).once('value', function(snapshot) {
            if (snapshot.exists() && snapshot.val().slides) {
                slides = JSON.parse(snapshot.val().slides);
                currentSlide = 0;
                loadSlide(currentSlide);
                updateSlideIndicator();
            } else if (snapshot.exists() && snapshot.val().json) {
                // Fallback for old format
                canvas.loadFromJSON(snapshot.val().json, function() {
                    canvas.renderAll();
                    slides = [canvas.toJSON()];
                    currentSlide = 0;
                    updateSlideIndicator();
                });
            } else {
                document.body.insertAdjacentHTML('beforeend', `<div style="color:white;text-align:center;margin-top:40px;">Presentation not found!</div>`);
            }
        });
    }

    // Navigation events
    document.getElementById('next-slide-btn').onclick = function() {
        if (currentSlide < slides.length-1) {
            currentSlide++;
            loadSlide(currentSlide);
            updateSlideIndicator();
        }
    };
    document.getElementById('prev-slide-btn').onclick = function() {
        if (currentSlide > 0) {
            currentSlide--;
            loadSlide(currentSlide);
            updateSlideIndicator();
        }
    };
    </script>
</body>
</html>
