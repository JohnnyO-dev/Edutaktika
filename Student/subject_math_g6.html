<!-- Grade 6 ONLY Math Subject Page (Student) -->
<!-- This file is a copy of subject_math.html restricted to students with gradelevel === '6' -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Math (Grade 6)</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<link rel="stylesheet" href="../CSS/header.css">
<link rel="stylesheet" href="../CSS/subject.css">
<link rel="stylesheet" href="../CSS/footer.css">
<link rel="stylesheet" href="../CSS/editProfile.css">
<style>
.guard-msg{padding:40px 24px;text-align:center;font-family:sans-serif;}
</style>
</head>
<body>
<div id="gradeGuard" class="guard-msg" style="display:none;">Checking access…</div>
<div id="mainContent" style="display:none;">
    <header>
        <div class="floating-elements"><div class="floating-element"></div><div class="floating-element"></div><div class="floating-element"></div><div class="floating-element"></div></div>
        <div class="header-content">
            <div class="logo"><div class="logo-icon"><i class="fas fa-graduation-cap"></i></div><div class="logo-text"><span>E</span><span>d</span><span>u</span><span>t</span><span>a</span><span>k</span><span>t</span><span>i</span><span>k</span><span>a</span></div></div>
            <nav>
                <ul>
                    <li><a href="homepage.html">Home</a></li>
                    <li class="dropdown"><a href="#" class="dropbtn">Subject <i class="fa fa-caret-down"></i></a>
                        <ul class="dropdown-content">
                            <li><a href="subject_math_g6.html" class="active">Math G6</a></li>
                            <li><a href="subject_english_g6.html">English G6</a></li>
                            <li><a href="subject_science_g6.html">Science G6</a></li>
                        </ul>
                    </li>
                    <li class="dropdown"><a href="#" class="dropbtn">Leaderboard <i class="fa fa-caret-down"></i></a>
                        <ul class="dropdown-content">
                            <li><a href="leaderboard_math.html">Math</a></li>
                            <li><a href="leaderboard_english.html">English</a></li>
                            <li><a href="leaderboard_science.html">Science</a></li>
                        </ul>
                    </li>
                    <li><a href="#" id="profileBtn"><i class="fas fa-user-circle"></i> Profile</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Profile Sidebar (reuse structure) -->
    <div id="profileSidebar" class="profile-sidebar">
        <div class="sidebar-content">
            <button class="close-btn" id="closeSidebar">&times;</button>
            <div style="position:relative; display:flex; flex-direction:column; align-items:center;">
                <img class="profile-avatar" id="profileAvatar" src="https://api.dicebear.com/7.x/bottts/svg?seed=user" alt="Profile Avatar">
                <i class="fa-solid fa-star sidebar-star" style="position:absolute; bottom:0; right:10px; color:#ffd700; font-size:1.2rem; background:white; border-radius:50%; padding:2px 4px; box-shadow:0 1px 4px #ffd70044;"></i>
            </div>
            <div class="profile-name" id="profileName">Loading...</div>
            <br>
            <div class="profile-info" style="width:100%;max-width:260px;margin-bottom:24px;">
                <div class="profile-role" style="color:#2e8b57; font-weight:700; font-size:1.1rem; margin-bottom:8px; letter-spacing:1px; text-align:center;">Student (Grade 6)</div>
                <div><strong>ID:</strong> <span id="profileId">-</span></div>
                <div><strong>First Name:</strong> <span id="profileFirstName">-</span></div>
                <div><strong>Middle Name:</strong> <span id="profileMiddleName">-</span></div>
                <div><strong>Last Name:</strong> <span id="profileLastName">-</span></div>
                <div><strong>Grade Level:</strong> <span id="profileGrade">-</span></div>
                <div><strong>Section:</strong> <span id="profileSection">-</span></div>
            </div>
            <div class="logout-switch-row">
                <div class="logout-switch" id="logoutSwitch"><div class="logout-switch-circle"></div></div>
                <span class="logout-label" id="logoutLabel">LOGOUT</span>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="quarter-nav">
            <div class="quarter-tab active" data-quarter="1">Quarter 1</div>
            <div class="quarter-tab" data-quarter="2">Quarter 2</div>
            <div class="quarter-tab" data-quarter="3">Quarter 3</div>
            <div class="quarter-tab" data-quarter="4">Quarter 4</div>
            <div class="quarter-tab" data-quarter="5" style="margin-left:auto;">Quizzes</div>
            <div class="quarter-tab" data-quarter="assessments">Assessments</div>
        </div>
        <div class="quarter-section active" id="quarter-1">
            <div class="quarter-title"><i class="fas fa-calendar-alt"></i><h2>Quarter 1: <span class="bounce-word"><span>F</span><span>o</span><span>u</span><span>n</span><span>d</span><span>a</span><span>t</span><span>i</span><span>o</span><span>n</span><span>s</span></span></h2></div>
            <div class="lessons-container"></div>
            <div id="youtube-lessons" data-channel-id="UCjPqk3KZAKIdGShdVLx9fqQ" style="margin-top:20px;">
                <div class="quarter-title" style="align-items:center; gap:10px;"><i class="fab fa-youtube"></i><h3 style="margin:0;">Video Lessons</h3></div>
                <div class="lessons-container"><div>Loading YouTube lessons…</div></div>
            </div>
        </div>
        <div class="quarter-section" id="quarter-2"><div class="quarter-title"><i class="fas fa-calendar-alt"></i><h2>Quarter 2</h2></div><div class="lessons-container"></div></div>
        <div class="quarter-section" id="quarter-3"><div class="quarter-title"><i class="fas fa-calendar-alt"></i><h2>Quarter 3</h2></div><div class="lessons-container"></div></div>
        <div class="quarter-section" id="quarter-4"><div class="quarter-title"><i class="fas fa-calendar-alt"></i><h2>Quarter 4</h2></div><div class="lessons-container"></div></div>
        <div class="quarter-section" id="quarter-5"><div class="quarter-title"><i class="fas fa-gamepad"></i><h2>Quizzes</h2></div><div class="lessons-container" id="quizzesContainer"></div></div>
        <div class="quarter-section" id="quarter-assessments"><div class="quarter-title"><i class="fas fa-clipboard-check"></i><h2>Assessments</h2></div><div class="lessons-container" id="assessmentsContainer"></div></div>
    </div>

    <footer>
        <div class="footer-content"><div class="footer-column"><h3 class="edu">Eduktaktika</h3><p>Interactive learning for Grade 6 students.</p></div></div>
        <div class="footer-bottom"><p>© 2025 Eduktaktika. All rights reserved.</p></div>
    </footer>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
const firebaseConfig = { apiKey:"AIzaSyB5BbeLLvPX8l1c4Lq0f-CmIUml4hQOQlE", authDomain:"edutaktika.firebaseapp.com", databaseURL:"https://edutaktika-default-rtdb.firebaseio.com", projectId:"edutaktika", storageBucket:"edutaktika.appspot.com", messagingSenderId:"676848575316", appId:"1:676848575316:web:f78f8c0f83bf3d9dfb5ec1" };
if(!firebase.apps.length){ firebase.initializeApp(firebaseConfig);} 
const db=firebase.database();
const auth=firebase.auth();
const subjectPage='subject_math';

function guardFail(msg){
  const g=document.getElementById('gradeGuard');
  g.style.display='block';
  g.innerHTML = `<h2 style="color:#c62828;">Access Denied</h2><p>${msg}</p><p><a href='homepage.html'>Return to homepage</a></p>`;
  document.getElementById('mainContent').style.display='none';
}

auth.onAuthStateChanged(async user=>{
  if(!user){ guardFail('Please log in as a Grade 6 student.'); return; }
  const snap=await db.ref('students/'+user.uid).once('value');
  const data=snap.val();
  if(!data || data.role!=='student'){ guardFail('Only students can view this page.'); return; }
  if((data.gradelevel||'').toString().trim()!=='6'){ guardFail('This page is restricted to Grade 6 students.'); return; }
  // Passed gate
  document.getElementById('gradeGuard').style.display='none';
  document.getElementById('mainContent').style.display='block';
  // Populate profile
  profileFill(data,user.uid);
  // Load lessons filtered by section
  if(!data.section){ return; }
  let teacherUID=null;
  const teachersSnap=await db.ref('teachers').once('value');
  teachersSnap.forEach(ts=>{ const t=ts.val(); if(t && t.section && t.section.trim().toLowerCase()===(data.section||'').trim().toLowerCase()) teacherUID=ts.key; });
  if(!teacherUID){ document.querySelectorAll('.lessons-container').forEach(c=>{ if(!c.children.length) c.innerHTML='<div>No teacher found for your section.</div>';}); return; }
  for(let q=1;q<=4;q++){
    const cont=document.querySelector(`#quarter-${q} .lessons-container`);
    if(!cont) continue; cont.innerHTML='';
    const path=`teachers/${teacherUID}/sections/${data.section}/lessons/${subjectPage}/quarter-${q}`;
    const lessonSnap=await db.ref(path).once('value');
    if(!lessonSnap.exists()){ cont.innerHTML='<div>No lessons found for this quarter.</div>'; continue; }
    const lessons=[]; lessonSnap.forEach(ch=>{ const v=ch.val(); lessons.push({title:v.title||ch.key, description:v.description||''}); });
    lessons.sort((a,b)=>a.title.localeCompare(b.title));
    cont.innerHTML=lessons.map(ls=>`<div class='lesson-item' data-presentation='${ls.title}'>
      <div class='lesson-thumbnail' style='background-color: var(--peach)'></div>
      <div class='lesson-title'><h3>${ls.title}</h3><p>${ls.description}</p><span class='lesson-badge' style='cursor:pointer;' onclick="window.location.href='present.html?subject=${subjectPage}&quarter=${q}&name=${encodeURIComponent(ls.title)}'">View</span></div>
    </div>`).join('');
  }
  loadYouTubeVideosStudent();
});

function profileFill(d,uid){
 document.getElementById('profileName').textContent=(d.fname||'')+' '+(d.lname||'');
 document.getElementById('profileId').textContent=d.id||uid;
 document.getElementById('profileFirstName').textContent=d.fname||'';
 document.getElementById('profileMiddleName').textContent=d.mname||'';
 document.getElementById('profileLastName').textContent=d.lname||'';
 document.getElementById('profileGrade').textContent=d.gradelevel||'';
 document.getElementById('profileSection').textContent=d.section||'';
 document.getElementById('profileAvatar').src='https://api.dicebear.com/7.x/bottts/svg?seed=' + encodeURIComponent(d.fname||'user');
}

document.getElementById('logoutSwitch').onclick=()=>auth.signOut().then(()=>window.location.href='../index.html');

// Quarter tab switching
 document.addEventListener('click',e=>{ const tab=e.target.closest('.quarter-tab'); if(!tab) return; document.querySelectorAll('.quarter-tab').forEach(t=>t.classList.remove('active')); tab.classList.add('active'); const target=tab.getAttribute('data-quarter'); document.querySelectorAll('.quarter-section').forEach(s=>s.classList.remove('active')); if(target==='assessments'){ document.getElementById('quarter-assessments').classList.add('active'); } else { const sec=document.getElementById('quarter-'+target); if(sec) sec.classList.add('active'); }});

// Video loader with fallback
async function loadYouTubeVideosStudent(){
  const wrapper=document.getElementById('youtube-lessons'); if(!wrapper) return;
  let container=wrapper.querySelector('.lessons-container'); if(!container){ container=document.createElement('div'); container.className='lessons-container'; wrapper.appendChild(container); }
  const channelId=(wrapper.dataset.channelId||'').trim(); if(!channelId){ container.innerHTML='<div style="color:#888;">Channel not configured.</div>'; return; }
  const feedUrl=`https://www.youtube.com/feeds/videos.xml?channel_id=${encodeURIComponent(channelId)}`;
  async function fetchWithCors(url){
    try{ const r=await fetch(url); if(r.ok) return await r.text(); throw new Error('HTTP '+r.status); }catch(e1){ try{ let rJ=await fetch(`https://r.jina.ai/https://www.youtube.com/feeds/videos.xml?channel_id=${encodeURIComponent(channelId)}`); if(rJ.ok) return await rJ.text(); throw new Error('Jina fail'); }catch(eJ){ try{ const r2=await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`); if(r2.ok) return await r2.text(); throw new Error('AO fail'); }catch(e2){ const r3=await fetch(`https://cors.isomorphic-git.org/${url}`); if(r3.ok) return await r3.text(); throw new Error('All fallbacks failed'); } } }
  }
  try{
    const xml=await fetchWithCors(feedUrl); const doc=new DOMParser().parseFromString(xml,'text/xml'); const entries=[...doc.getElementsByTagName('entry')];
    if(!entries.length){ return playlistFallback(); }
    container.innerHTML=''; entries.slice(0,5).forEach(en=>{ const title=en.getElementsByTagName('title')[0]?.textContent||'Video'; const vid=en.getElementsByTagName('yt:videoId')[0]?.textContent||en.getElementsByTagName('videoId')[0]?.textContent||''; if(!vid) return; const desc=en.getElementsByTagName('summary')[0]?.textContent||''; const short=desc.length>100?desc.substring(0,100)+'…':desc; const thumb=`https://i.ytimg.com/vi/${vid}/hqdefault.jpg`; container.insertAdjacentHTML('beforeend',`<div class='lesson-item'><div class='lesson-thumbnail' style="background-image:url('${thumb}');background-size:cover;background-position:center;"></div><div class='lesson-title'><h3>${title}</h3><p>${short}</p><span class='lesson-badge' style='cursor:pointer;' onclick="window.location.href='video.html?id=${vid}'">Watch</span></div></div>`); }); if(!container.children.length) playlistFallback();
  }catch(err){ console.error('Video load error G6',err); playlistFallback(); }
  function playlistFallback(){ const uploadsId=channelId.startsWith('UC')?('UU'+channelId.slice(2)):''; if(!uploadsId){ container.innerHTML='<div>No videos available.</div>'; return;} container.innerHTML=`<div style='width:100%;max-width:720px;'><div class='quarter-title' style='align-items:center;gap:10px;'><i class='fab fa-youtube'></i><h3 style='margin:0;'>Latest Videos</h3></div><div style='position:relative;padding-top:56.25%;border-radius:8px;overflow:hidden;box-shadow:0 2px 12px #0001;margin-top:8px;'><iframe src='https://www.youtube.com/embed/videoseries?list=${uploadsId}' title='YouTube playlist' style='position:absolute;top:0;left:0;width:100%;height:100%;border:0;' allow='accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share' allowfullscreen loading='lazy'></iframe></div></div>`; }
}
</script>
</body>
</html>