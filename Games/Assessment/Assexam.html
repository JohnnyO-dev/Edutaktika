<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Assessment 1 - Everyday Math</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <!-- Site global styles -->
  <link rel="stylesheet" href="../../CSS/header.css">
  <link rel="stylesheet" href="../../CSS/footer.css">
  <style>
    /* Page specific styles */
    body { font-family: Arial, sans-serif; background:#f9f9f9; margin:0; }
    main { padding:100px 20px 40px; min-height:calc(100vh - 260px); }
    .quiz-container { max-width:640px; margin:auto; background:#fff; padding:28px 28px 32px; border-radius:16px; box-shadow:0 6px 18px rgba(0,0,0,0.08); position:relative; }
    .quiz-container h2 { margin-top:0; }
    .question { font-size:18px; margin-bottom:15px; font-weight:600; }
    .options label { display:block; padding:10px 14px; margin-bottom:10px; border:1px solid #ddd; border-radius:10px; cursor:pointer; transition:.18s; background:#fafafa; }
    .options label:hover { background:#f1f5ff; border-color:#b6c8ff; }
    .options input[type=radio] { margin-right:6px; }
    button { margin-top:15px; padding:12px 26px; background:#4285f4; border:none; color:#fff; border-radius:8px; cursor:pointer; font-size:16px; font-weight:600; letter-spacing:.3px; }
    button:disabled { background:#9bbcf1; cursor:not-allowed; }
    #result { margin-top:24px; font-weight:bold; font-size:18px; }
    #uploadStatus { margin-top:8px; font-size:14px; color:#555; }
    .attempts-btn { background:#6d28d9; }
    .attempts-btn:hover { filter:brightness(1.05); }
    /* Attempts Modal */
    #attemptsModal { display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.45); z-index:1200; align-items:center; justify-content:center; }
    #attemptsModal .modal-content { background:#fff; padding:24px 28px; border-radius:18px; width:95%; max-width:520px; max-height:80vh; overflow:auto; box-shadow:0 8px 28px #0004; }
    #attemptsModal h3 { margin-top:0; }
    .attempt-row { display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #eee; font-size:14px; font-family:monospace; }
    .attempt-row:last-child { border-bottom:none; }
    .back-link { position:absolute; top:-42px; left:0; text-decoration:none; font-size:14px; font-weight:600; color:#4285f4; display:flex; align-items:center; gap:6px; }
    .back-link i { font-size:16px; }
    footer { margin-top:60px; }
  </style>
</head>
<body>
  <!-- Site Header -->
  <header>
    <div class="floating-elements">
      <div class="floating-element"></div>
      <div class="floating-element"></div>
      <div class="floating-element"></div>
      <div class="floating-element"></div>
    </div>
    <div class="header-content">
      <div class="logo">
        <div class="logo-icon"><i class="fas fa-graduation-cap"></i></div>
        <div class="logo-text"><span>E</span><span>d</span><span>u</span><span>t</span><span>a</span><span>k</span><span>t</span><span>i</span><span>k</span><span>a</span></div>
      </div>
      <nav>
        <ul>
          <li><a href="../../Student/homepage.html">Home</a></li>
          <li><a href="../../Student/subject_math.html">Math</a></li>
          <li><a href="../../Student/subject_english.html">English</a></li>
          <li><a href="../../Student/subject_science.html">Science</a></li>
          <li><a href="../../Student/leaderboard.html">Leaderboard</a></li>
        </ul>
      </nav>
    </div>
  </header>
  <main>
  <div class="quiz-container">
    <a class="back-link" href="../../Student/subject_math.html"><i class="fa fa-arrow-left"></i> Back to Math</a>
    <h2 style="margin-top:0;text-align:center;">Assessment 1: Math in Everyday Life</h2>
    <div id="quiz">
      <div class="question" id="questionText"></div>
      <div class="options" id="options"></div>
      <button id="nextBtn">Next</button>
      <div id="result"></div>
      <div id="uploadStatus"></div>
      <button id="viewAttemptsBtn" class="attempts-btn" style="display:none;">View Attempts</button>
    </div>
  </div>

  <!-- Attempts Modal -->
  <div id="attemptsModal">
    <div class="modal-content">
      <h3>Your Attempts</h3>
      <div id="attemptsList">Loading...</div>
      <div style="text-align:right;margin-top:18px;">
        <button onclick="closeAttemptsModal()">Close</button>
      </div>
    </div>
  </div>
  </main>
  <!-- Footer -->
  <footer>
    <div class="footer-content">
      <div class="footer-column">
        <h3 class="edu">Edutaktika</h3>
        <p>Making learning fun and engaging through interactive game-based education.</p>
      </div>
      <div class="footer-column">
        <h3>Quick Links</h3>
        <ul>
          <li><a href="../../Student/homepage.html">Home</a></li>
          <li><a href="../../Student/subject_math.html">Math</a></li>
          <li><a href="../../Student/leaderboard.html">Leaderboard</a></li>
        </ul>
      </div>
      <div class="footer-column">
        <h3>Support</h3>
        <ul>
          <li><a href="#">Help Center</a></li>
          <li><a href="#">Contact Us</a></li>
          <li><a href="#">Privacy Policy</a></li>
          <li><a href="#">Terms of Service</a></li>
        </ul>
      </div>
    </div>
    <div class="footer-bottom">
      <div class="footer-links">
        <a href="#"><i class="fab fa-facebook"></i></a>
        <a href="#"><i class="fab fa-twitter"></i></a>
        <a href="#"><i class="fab fa-instagram"></i></a>
        <a href="#"><i class="fab fa-youtube"></i></a>
      </div>
      <p>Â© 2025 Edutaktika. All rights reserved.</p>
    </div>
  </footer>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script>
    const firebaseConfig = { apiKey:"AIzaSyB5BbeLLvPX8l1c4Lq0f-CmIUml4hQOQlE", authDomain:"edutaktika.firebaseapp.com", databaseURL:"https://edutaktika-default-rtdb.firebaseio.com", projectId:"edutaktika", storageBucket:"edutaktika.appspot.com", messagingSenderId:"676848575316", appId:"1:676848575316:web:f78f8c0f83bf3d9dfb5ec1", measurementId:"G-X3GT5TNN87" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    const ASSESSMENT_KEY = 'assessment1';

    const quizData = [
      { question: "You buy 3 apples at 12 pesos each. How much do you pay?", options: ["15","24","30","36"], correct:2 },
      { question: "A jeepney fare is 12 pesos. You have 50 pesos. How much change after 1 ride?", options: ["32","36","38","40"], correct:3 },
      { question: "Mom cuts a pizza into 8 equal slices. You eat 3. What fraction is left?", options: ["3/8","5/8","1/2","8/3"], correct:1 },
      { question: "You read 12 pages yesterday and 18 today. How many pages total?", options: ["20","25","30","32"], correct:2 },
      { question: "A notebook costs 25 pesos. How many can you buy with 100 pesos?", options: ["2","3","4","5"], correct:2 },
      { question: "There are 5 days of school this week. You attended 4. What percent attended?", options: ["60%","70%","75%","80%"], correct:3 },
      { question: "A bottle holds 1 liter. How many liters do 5 bottles hold?", options: ["3","4","5","10"], correct:2 },
      { question: "You have 48 candies to share equally among 6 friends (including you). How many each?", options: ["6","7","8","9"], correct:2 },
      { question: "A clock shows 3:15. How many minutes after 3 o'clock?", options: ["10","12","15","20"], correct:2 },
      { question: "You sleep at 9 PM and wake at 6 AM. How many hours of sleep?", options: ["7","8","9","10"], correct:2 }
    ];

    let currentQuestion = 0;
    let score = 0;

    const questionText = document.getElementById('questionText');
    const optionsContainer = document.getElementById('options');
    const nextBtn = document.getElementById('nextBtn');
    const resultDiv = document.getElementById('result');
    const uploadStatus = document.getElementById('uploadStatus');
    const viewAttemptsBtn = document.getElementById('viewAttemptsBtn');

    function loadQuestion(){
      const q = quizData[currentQuestion];
      questionText.textContent = `Question ${currentQuestion + 1}: ${q.question}`;
      optionsContainer.innerHTML='';
      q.options.forEach((opt,i)=>{
        const label = document.createElement('label');
        label.innerHTML = `<input type="radio" name="option" value="${i}"> ${opt}`;
        optionsContainer.appendChild(label);
      });
      nextBtn.disabled = true;
      optionsContainer.querySelectorAll('input[name="option"]').forEach(r=>r.addEventListener('change',()=>{nextBtn.disabled=false;}));
      nextBtn.textContent = currentQuestion === quizData.length -1 ? 'Finish' : 'Next';
    }

    nextBtn.addEventListener('click', ()=>{
      const sel = document.querySelector("input[name='option']:checked");
      if(!sel) return;
      if(parseInt(sel.value) === quizData[currentQuestion].correct) score++;
      currentQuestion++;
      if(currentQuestion < quizData.length) loadQuestion(); else showResult();
    });

    function showResult(){
      questionText.style.display='none';
      optionsContainer.style.display='none';
      nextBtn.style.display='none';
      resultDiv.innerHTML = `You scored ${score} out of ${quizData.length}`;
      saveAttempt(score, quizData.length);
    }

    function requireAuthUid(){
      const u = auth.currentUser; if(!u){ uploadStatus.textContent='Login required to save score.'; return null;} return u.uid; }

    const USE_STUDENT_PATH = true; // set to true to store under students/<uid>/assessments (more permissive in your current rules)

    function primaryAttemptRef(uid){
      return db.ref(`assessmentAttempts/${ASSESSMENT_KEY}/${uid}`).push();
    }
    function studentAttemptRef(uid){
      return db.ref(`students/${uid}/assessments/${ASSESSMENT_KEY}/attempts`).push();
    }
    function summaryRefPrimary(uid){
      return db.ref(`assessmentSummaries/${ASSESSMENT_KEY}/${uid}`);
    }
    function summaryRefStudent(uid){
      return db.ref(`students/${uid}/assessments/${ASSESSMENT_KEY}/summary`);
    }

    function saveAttempt(rawScore,total){
      const uid = requireAuthUid(); if(!uid) return;
      const payload = { score:rawScore, total:total, percentage: Math.round(rawScore/total*100), timestamp: Date.now() };
      uploadStatus.textContent='Saving attempt...';

      // choose primary path first unless flag forces student path
      const tryPrimary = !USE_STUDENT_PATH;
      const doPrimary = () => {
        const ref = primaryAttemptRef(uid);
        return ref.set(payload).then(()=> updateSummary(uid, payload, true)).catch(err=>{ throw err; });
      };
      const doStudent = () => {
        const ref = studentAttemptRef(uid);
        return ref.set(payload).then(()=> updateSummary(uid, payload, false));
      };

      const exec = tryPrimary ? doPrimary().catch(err => {
        if(err && err.code === 'PERMISSION_DENIED'){ return doStudent(); }
        throw err;
      }) : doStudent();

      exec.then(()=>{
        uploadStatus.textContent='Attempt saved â';
        viewAttemptsBtn.style.display='inline-block';
      }).catch(e=>{
        uploadStatus.textContent='Save failed: '+ e.message + ' (check DB rules)';
        console.error('Attempt save error', e);
      });
    }

    function updateSummary(uid, payload, usedPrimary){
      const ref = (USE_STUDENT_PATH || !usedPrimary) ? summaryRefStudent(uid) : summaryRefPrimary(uid);
      return ref.transaction(current => {
        if(!current) return { best: payload.score, bestPercentage: payload.percentage, last: payload.score, lastPercentage: payload.percentage, total: payload.total, attempts:1, lastTimestamp: payload.timestamp };
        const best = Math.max(current.best || 0, payload.score);
        return { best, bestPercentage: Math.round(best/payload.total*100), last: payload.score, lastPercentage: payload.percentage, total: payload.total, attempts:(current.attempts||0)+1, lastTimestamp: payload.timestamp };
      });
    }

    // Attempts modal logic
    function openAttemptsModal(){
      const modal = document.getElementById('attemptsModal');
      modal.style.display='flex';
      loadAttempts();
    }
    function closeAttemptsModal(){ document.getElementById('attemptsModal').style.display='none'; }
    window.closeAttemptsModal = closeAttemptsModal; // expose

    function loadAttempts(){
      const uid = requireAuthUid(); if(!uid) return;
      const listDiv = document.getElementById('attemptsList');
      listDiv.textContent='Loading...';
      // decide path
      const attemptsPath = (USE_STUDENT_PATH ? `students/${uid}/assessments/${ASSESSMENT_KEY}/attempts` : `assessmentAttempts/${ASSESSMENT_KEY}/${uid}`);
      db.ref(attemptsPath).orderByChild('timestamp').once('value', snap => {
        if(!snap.exists()) { listDiv.textContent='No attempts yet.'; return; }
        const rows=[]; snap.forEach(child => rows.push(child.val()));
        rows.sort((a,b)=> b.timestamp - a.timestamp);
        listDiv.innerHTML = rows.map((a,i)=>{ const ds = new Date(a.timestamp).toLocaleString(); return `<div class='attempt-row'><span>#${rows.length - i}</span><span>${a.score}/${a.total}</span><span>${a.percentage}%</span><span>${ds}</span></div>`; }).join('');
      }).catch(e=>{ listDiv.textContent='Load failed: '+e.message; });
    }

    viewAttemptsBtn.addEventListener('click', openAttemptsModal);

    auth.onAuthStateChanged(u=>{ if(u){ viewAttemptsBtn.style.display='inline-block'; } });

    loadQuestion();
  </script>
</body>
</html>
